"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.authFlow = exports.signInBot = exports.signInWithPassword = exports.sendCode = exports.signInUserWithQrCode = exports.signInUser = exports.checkAuthorization = exports.start = void 0;
const tl_1 = require("../tl");
const utils = __importStar(require("../Utils"));
const Helpers_1 = require("../Helpers");
const Password_1 = require("../Password");
const QR_CODE_TIMEOUT = 30000;
// region public methods
function start(client, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        if (!client.connected) {
            yield client.connect();
        }
        if (yield client.checkAuthorization()) {
            return;
        }
        const apiCredentials = {
            apiId: client.apiId,
            apiHash: client.apiHash,
        };
        yield client.authFlow(apiCredentials, authParams);
    });
}
exports.start = start;
function checkAuthorization(client) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            yield client.invoke(new tl_1.Api.updates.GetState());
            return true;
        }
        catch (e) {
            return false;
        }
    });
}
exports.checkAuthorization = checkAuthorization;
function signInUser(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        let phoneNumber;
        let phoneCodeHash;
        let isCodeViaApp = false;
        while (1) {
            try {
                if (typeof authParams.phoneNumber === "function") {
                    try {
                        phoneNumber = yield authParams.phoneNumber();
                    }
                    catch (err) {
                        if (err.message === "RESTART_AUTH_WITH_QR") {
                            return client.signInUserWithQrCode(apiCredentials, authParams);
                        }
                        throw err;
                    }
                }
                else {
                    phoneNumber = authParams.phoneNumber;
                }
                const sendCodeResult = yield client.sendCode(apiCredentials, phoneNumber, authParams.forceSMS);
                phoneCodeHash = sendCodeResult.phoneCodeHash;
                isCodeViaApp = sendCodeResult.isCodeViaApp;
                if (typeof phoneCodeHash !== "string") {
                    throw new Error("Failed to retrieve phone code hash");
                }
                break;
            }
            catch (err) {
                if (typeof authParams.phoneNumber !== "function") {
                    throw err;
                }
                const shouldWeStop = yield authParams.onError(err);
                if (shouldWeStop) {
                    throw new Error("AUTH_USER_CANCEL");
                }
            }
        }
        let phoneCode;
        let isRegistrationRequired = false;
        let termsOfService;
        while (1) {
            try {
                try {
                    phoneCode = yield authParams.phoneCode(isCodeViaApp);
                }
                catch (err) {
                    // This is the support for changing phone number from the phone code screen.
                    if (err.message === "RESTART_AUTH") {
                        return client.signInUser(apiCredentials, authParams);
                    }
                }
                if (!phoneCode) {
                    throw new Error("Code is empty");
                }
                // May raise PhoneCodeEmptyError, PhoneCodeExpiredError,
                // PhoneCodeHashEmptyError or PhoneCodeInvalidError.
                const result = yield client.invoke(new tl_1.Api.auth.SignIn({
                    phoneNumber,
                    phoneCodeHash,
                    phoneCode,
                }));
                if (result instanceof tl_1.Api.auth.AuthorizationSignUpRequired) {
                    isRegistrationRequired = true;
                    termsOfService = result.termsOfService;
                    break;
                }
                return result.user;
            }
            catch (err) {
                if (err.message === "SESSION_PASSWORD_NEEDED") {
                    return client.signInWithPassword(apiCredentials, authParams);
                }
                else {
                    const shouldWeStop = yield authParams.onError(err);
                    if (shouldWeStop) {
                        throw new Error("AUTH_USER_CANCEL");
                    }
                }
            }
        }
        if (isRegistrationRequired) {
            while (1) {
                try {
                    let lastName;
                    let firstName = "first name";
                    if (authParams.firstAndLastNames) {
                        const result = yield authParams.firstAndLastNames();
                        firstName = result[0];
                        lastName = result[1];
                    }
                    if (!firstName) {
                        throw new Error("First name is required");
                    }
                    const { user } = (yield client.invoke(new tl_1.Api.auth.SignUp({
                        phoneNumber,
                        phoneCodeHash,
                        firstName,
                        lastName,
                    })));
                    if (termsOfService) {
                        // This is a violation of Telegram rules: the user should be presented with and accept TOS.
                        yield client.invoke(new tl_1.Api.help.AcceptTermsOfService({
                            id: termsOfService.id,
                        }));
                    }
                    return user;
                }
                catch (err) {
                    const shouldWeStop = yield authParams.onError(err);
                    if (shouldWeStop) {
                        throw new Error("AUTH_USER_CANCEL");
                    }
                }
            }
        }
        yield authParams.onError(new Error("Auth failed"));
        return client.signInUser(apiCredentials, authParams);
    });
}
exports.signInUser = signInUser;
function signInUserWithQrCode(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const inputPromise = (() => __awaiter(this, void 0, void 0, function* () {
            while (1) {
                const result = yield client.invoke(new tl_1.Api.auth.ExportLoginToken({
                    apiId: Number(process.env.TELEGRAM_T_API_ID),
                    apiHash: process.env.TELEGRAM_T_API_HASH,
                    exceptIds: [],
                }));
                if (!(result instanceof tl_1.Api.auth.LoginToken)) {
                    throw new Error("Unexpected");
                }
                const { token, expires } = result;
                if (authParams.qrCode) {
                    yield Promise.race([
                        authParams.qrCode({ token, expires }),
                        Helpers_1.sleep(QR_CODE_TIMEOUT),
                    ]);
                }
            }
        }))();
        const updatePromise = new Promise((resolve) => {
            client.addEventHandler((update) => {
                if (update instanceof tl_1.Api.UpdateLoginToken) {
                    resolve(undefined);
                }
            });
        });
        try {
            yield Promise.race([updatePromise, inputPromise]);
        }
        catch (err) {
            if (err.message === "RESTART_AUTH") {
                return client.signInUser(apiCredentials, authParams);
            }
            throw err;
        }
        try {
            const result2 = yield client.invoke(new tl_1.Api.auth.ExportLoginToken({
                apiId: Number(process.env.TELEGRAM_T_API_ID),
                apiHash: process.env.TELEGRAM_T_API_HASH,
                exceptIds: [],
            }));
            if (result2 instanceof tl_1.Api.auth.LoginTokenSuccess &&
                result2.authorization instanceof tl_1.Api.auth.Authorization) {
                return result2.authorization.user;
            }
            else if (result2 instanceof tl_1.Api.auth.LoginTokenMigrateTo) {
                yield client._switchDC(result2.dcId);
                const migratedResult = yield client.invoke(new tl_1.Api.auth.ImportLoginToken({
                    token: result2.token,
                }));
                if (migratedResult instanceof tl_1.Api.auth.LoginTokenSuccess &&
                    migratedResult.authorization instanceof tl_1.Api.auth.Authorization) {
                    return migratedResult.authorization.user;
                }
            }
        }
        catch (err) {
            if (err.message === "SESSION_PASSWORD_NEEDED") {
                return client.signInWithPassword(apiCredentials, authParams);
            }
        }
        yield authParams.onError(new Error("QR auth failed"));
        return client.signInUser(apiCredentials, authParams);
    });
}
exports.signInUserWithQrCode = signInUserWithQrCode;
function sendCode(client, apiCredentials, phoneNumber, forceSMS = false) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const { apiId, apiHash } = apiCredentials;
            const sendResult = yield client.invoke(new tl_1.Api.auth.SendCode({
                phoneNumber,
                apiId,
                apiHash,
                settings: new tl_1.Api.CodeSettings(),
            }));
            // If we already sent a SMS, do not resend the phoneCode (hash may be empty)
            if (!forceSMS || sendResult.type instanceof tl_1.Api.auth.SentCodeTypeSms) {
                return {
                    phoneCodeHash: sendResult.phoneCodeHash,
                    isCodeViaApp: sendResult.type instanceof tl_1.Api.auth.SentCodeTypeApp,
                };
            }
            const resendResult = yield client.invoke(new tl_1.Api.auth.ResendCode({
                phoneNumber,
                phoneCodeHash: sendResult.phoneCodeHash,
            }));
            return {
                phoneCodeHash: resendResult.phoneCodeHash,
                isCodeViaApp: resendResult.type instanceof tl_1.Api.auth.SentCodeTypeApp,
            };
        }
        catch (err) {
            if (err.message === "AUTH_RESTART") {
                return client.sendCode(apiCredentials, phoneNumber, forceSMS);
            }
            else {
                throw err;
            }
        }
    });
}
exports.sendCode = sendCode;
function signInWithPassword(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        while (1) {
            try {
                const passwordSrpResult = yield client.invoke(new tl_1.Api.account.GetPassword());
                const password = yield authParams.password(passwordSrpResult.hint);
                if (!password) {
                    throw new Error("Password is empty");
                }
                const passwordSrpCheck = yield Password_1.computeCheck(passwordSrpResult, password);
                const { user } = (yield client.invoke(new tl_1.Api.auth.CheckPassword({
                    password: passwordSrpCheck,
                })));
                return user;
            }
            catch (err) {
                const shouldWeStop = yield authParams.onError(err);
                if (shouldWeStop) {
                    throw new Error("AUTH_USER_CANCEL");
                }
            }
        }
        return undefined; // Never reached (TypeScript fix)
    });
}
exports.signInWithPassword = signInWithPassword;
function signInBot(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const { apiId, apiHash } = apiCredentials;
        let { botAuthToken } = authParams;
        if (!botAuthToken) {
            throw new Error("a valid BotToken is required");
        }
        if (typeof botAuthToken === "function") {
            let token;
            while (true) {
                token = yield botAuthToken();
                if (token) {
                    botAuthToken = token;
                    break;
                }
            }
        }
        const { user } = (yield client.invoke(new tl_1.Api.auth.ImportBotAuthorization({
            apiId,
            apiHash,
            botAuthToken,
        })));
        return user;
    });
}
exports.signInBot = signInBot;
function authFlow(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const me = "phoneNumber" in authParams
            ? yield client.signInUser(apiCredentials, authParams)
            : yield client.signInBot(apiCredentials, authParams);
        // TODO @logger
        client._log.info("Signed in successfully as " + utils.getDisplayName(me));
    });
}
exports.authFlow = authFlow;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2dyYW1qcy9jbGllbnQvYXV0aC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsOEJBQTRCO0FBQzVCLGdEQUFrQztBQUNsQyx3Q0FBbUM7QUFDbkMsMENBQXNFO0FBMEJ0RSxNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUM7QUFFOUIsd0JBQXdCO0FBRXhCLFNBQXNCLEtBQUssQ0FDdkIsTUFBc0IsRUFDdEIsVUFBMEM7O1FBRTFDLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFO1lBQ25CLE1BQU0sTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQzFCO1FBRUQsSUFBSSxNQUFNLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxFQUFFO1lBQ25DLE9BQU87U0FDVjtRQUVELE1BQU0sY0FBYyxHQUFHO1lBQ25CLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSztZQUNuQixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU87U0FDMUIsQ0FBQztRQUVGLE1BQU0sTUFBTSxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDdEQsQ0FBQztDQUFBO0FBbEJELHNCQWtCQztBQUVELFNBQXNCLGtCQUFrQixDQUFDLE1BQXNCOztRQUMzRCxJQUFJO1lBQ0EsTUFBTSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksUUFBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNSLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO0lBQ0wsQ0FBQztDQUFBO0FBUEQsZ0RBT0M7QUFFRCxTQUFzQixVQUFVLENBQzVCLE1BQXNCLEVBQ3RCLGNBQThCLEVBQzlCLFVBQTBCOztRQUUxQixJQUFJLFdBQVcsQ0FBQztRQUNoQixJQUFJLGFBQWEsQ0FB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