"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventCommon = exports.EventBuilder = exports._intoIdSet = void 0;
const tl_1 = require("../tl");
const custom_1 = require("../tl/custom");
const Helpers_1 = require("../Helpers");
const __1 = require("../");
function _intoIdSet(client, chats) {
    return __awaiter(this, void 0, void 0, function* () {
        if (chats == undefined) {
            return undefined;
        }
        if (!Helpers_1.isArrayLike(chats)) {
            chats = [chats];
        }
        const result = new Set();
        for (let chat of chats) {
            if (typeof chat == "number") {
                if (chat < 0) {
                    result.add(chat);
                }
                else {
                    result.add(__1.utils.getPeerId(new tl_1.Api.PeerUser({
                        userId: chat,
                    })));
                    result.add(__1.utils.getPeerId(new tl_1.Api.PeerChat({
                        chatId: chat,
                    })));
                    result.add(__1.utils.getPeerId(new tl_1.Api.PeerChannel({
                        channelId: chat,
                    })));
                }
            }
            else if (typeof chat == "object" &&
                chat.SUBCLASS_OF_ID == 0x2d45687) {
                result.add(__1.utils.getPeerId(chat));
            }
            else {
                chat = yield client.getInputEntity(chat);
                if (chat instanceof tl_1.Api.InputPeerSelf) {
                    chat = yield client.getMe(true);
                }
                result.add(__1.utils.getPeerId(chat));
            }
        }
        return Array.from(result);
    });
}
exports._intoIdSet = _intoIdSet;
class EventBuilder {
    constructor({ chats, blacklistChats = true, func }) {
        this.chats = chats;
        this.blacklistChats = blacklistChats;
        this.resolved = false;
        this.func = func;
    }
    build(update, others = null) {
        if (update)
            return update;
    }
    resolve(client) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.resolved) {
                return;
            }
            yield this._resolve(client);
            this.resolved = true;
        });
    }
    _resolve(client) {
        return __awaiter(this, void 0, void 0, function* () {
            this.chats = yield _intoIdSet(client, this.chats);
        });
    }
    filter(event) {
        if (!this.resolved) {
            return;
        }
        if (this.chats != undefined && event.chatId != undefined) {
            const inside = this.chats.includes(event.chatId);
            if (inside == this.blacklistChats) {
                // If this chat matches but it's a blacklist ignore.
                // If it doesn't match but it's a whitelist ignore.
                return;
            }
        }
        return event;
    }
}
exports.EventBuilder = EventBuilder;
class EventCommon extends custom_1.ChatGetter {
    constructor({ chatPeer = undefined, msgId = undefined, broadcast = undefined, }) {
        super({ chatPeer, broadcast });
        this._eventName = "Event";
        this._entities = new Map();
        this._client = undefined;
        this._messageId = msgId;
    }
    _setClient(client) {
        this._client = client;
    }
    get client() {
        return this._client;
    }
}
exports.EventCommon = EventCommon;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vZ3JhbWpzL2V2ZW50cy9jb21tb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsOEJBQTRCO0FBRTVCLHlDQUEwQztBQUkxQyx3Q0FBeUM7QUFDekMsMkJBQTRCO0FBRzVCLFNBQXNCLFVBQVUsQ0FDNUIsTUFBc0IsRUFDdEIsS0FBNEM7O1FBRTVDLElBQUksS0FBSyxJQUFJLFNBQVMsRUFBRTtZQUNwQixPQUFPLFNBQVMsQ0FBQztTQUNwQjtRQUNELElBQUksQ0FBQyxxQkFBVyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3JCLEtBQUssR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ25CO1FBQ0QsTUFBTSxNQUFNLEdBQWdCLElBQUksR0FBRyxFQUFVLENBQUM7UUFDOUMsS0FBSyxJQUFJLElBQUksSUFBSSxLQUFLLEVBQUU7WUFDcEIsSUFBSSxPQUFPLElBQUksSUFBSSxRQUFRLEVBQUU7Z0JBQ3pCLElBQUksSUFBSSxHQUFHLENBQUMsRUFBRTtvQkFDVixNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNwQjtxQkFBTTtvQkFDSCxNQUFNLENBQUMsR0FBRyxDQUNOLFNBQUssQ0FBQyxTQUFTLENBQ1gsSUFBSSxRQUFHLENBQUMsUUFBUSxDQUFDO3dCQUNiLE1BQU0sRUFBRSxJQUFJO3FCQUNmLENBQUMsQ0FDTCxDQUNKLENBQUM7b0JBQ0YsTUFBTSxDQUFDLEdBQUcsQ0FDTixTQUFLLENBQUMsU0FBUyxDQUNYLElBQUksUUFBRyxDQUFDLFFBQVEsQ0FBQzt3QkFDYixNQUFNLEVBQUUsSUFBSTtxQkFDZixDQUFDLENBQ0wsQ0FDSixDQUFDO29CQUNGLE1BQU0sQ0FBQyxHQUFHLENBQ04sU0FBSyxDQUFDLFNBQVMsQ0FDWCxJQUFJLFFBQUcsQ0FBQyxXQUFXLENBQUM7d0JBQ2hCLFNBQVMsRUFBRSxJQUFJO3FCQUNsQixDQUFDLENBQ0wsQ0FDSixDQUFDO2lCQUNMO2FBQ0o7aUJBQU0sSUFDSCxPQUFPLElBQUksSUFBSSxRQUFRO2dCQUN2QixJQUFJLENBQUMsY0FBYyxJQUFJLFNBQVMsRUFDbEM7Z0JBQ0UsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDckM7aUJBQU07Z0JBQ0gsSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDekMsSUFBSSxJQUFJLFlBQVksUUFBRyxDQUFDLGFBQWEsRUFBRTtvQkFDbkMsSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDbkM7Z0JBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDckM7U0FDSjtRQUNELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QixDQUFDO0NBQUE7QUFwREQsZ0NBb0RDO0FBUUQsTUFBYSxZQUFZO0lBTXJCLFlBQVksRUFBRSxLQUFLLEVBQUUsY0FBYyxHQUFHLElBQUksRUFBRSxJQUFJLEVBQXlCO1FBQ3JFLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBc0IsRUFBRSxNQUFNLEdBQUcsSUFBSTtRQUN2QyxJQUFJLE1BQU07WUFBRSxPQUFPLE1BQU0sQ0FBQztJQUM5QixDQUFDO0lBRUssT0FBTyxDQUFDLE1BQXNCOztZQUNoQyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2YsT0FBTzthQUNWO1lBQ0QsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzVCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLENBQUM7S0FBQTtJQUVLLFFBQVEsQ0FBQyxNQUFzQjs7WUFDakMsSUFBSSxDQUFDLEtBQUssR0FBRyxNQUFNLFVBQVUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RELENBQUM7S0FBQTtJQUVELE1BQU0sQ0FBQyxLQUFVO1FBQ2IsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDaEIsT0FBTztTQUNWO1FBQ0QsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLFNBQVMsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLFNBQVMsRUFBRTtZQUN0RCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDakQsSUFBSSxNQUFNLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtnQkFDL0Isb0RBQW9EO2dCQUNwRCxtREFBbUQ7Z0JBQ25ELE9BQU87YUFDVjtTQUNKO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztDQUNKO0FBM0NELG9DQTJDQztBQVFELE1BQWEsV0FBWSxTQUFRLG1CQUFVO0lBS3ZDLFlBQVksRUFDUixRQUFRLEdBQUcsU0FBUyxFQUNwQixLQUFLLEdBQUcsU0FBUyxFQUNqQixTQUFTLEdBQUcsU0FBUyxHQUNGO1FBQ25CLEtBQUssQ0FBQyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBVG5DLGVBQVUsR0FBRyxPQUFPLENBQUM7UUFVakIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBQzVCLENBQUM7SUFFRCxVQUFVLENBQUMsTUFBc0I7UUFDN0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7SUFDMUIsQ0FBQztJQUVELElBQUksTUFBTTtRQUNOLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDO0NBQ0o7QUF2QkQsa0NBdUJDIn0=